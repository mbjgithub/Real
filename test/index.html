<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <meta name="format-detection" content="telphone=no, email=no" />
    <script src="debug.js"></script>
	<title>REVE</title>
	<script src="/dist/real.js"></script>
	<style>
		body {padding: 0px;margin: 0;}
		.hl {color: cornflowerblue}
		.c-header {background-color: #f0f0f0;line-height: 50px;position: relative;}
			.c-header .c-button {position: absolute;top: 10px;height: 20px;right: 5px;}
		.content {text-align: center;height: 100px;margin-top: 50px;}
		.button-group {text-align: center;}
			.button-group button {line-height: 28px;color: white;background-color: cornflowerblue;border: 0;padding: 6px;
				outline: 0;border-radius: 4px;margin: 5px;}

		.footer {display: block;width: 100%;text-align: center;color: #ccc;text-decoration: underline;cursor: pointer;}
	</style>
</head>
<body>
	<div id="app" r-show="{show}" r-class="{hl: hl}">
		<div class="c-header" 
			r-component="c-header" 
			r-ref="header"
			r-data="{
				title: header;
			}"
			r-methods="{
				onRefresh: onRefresh;
			}"
			r-autorefresh="{onRefresh}"
		>
			<center r-html="{title}"></center>
			<button class="c-button" 
				r-component="c-button" 
				r-ref="button"
			>Home</button>
		</div>
		<span r-content>{header}</span>
		<h1 class="content">Hello world</h1>
		<div class="button-group">
			<button r-on="{
				click: onDisableHightlight
			}">disable hightlight</button>

			<button r-on="{
				click: onChangeHeader
			}">change child component's title</button>
		</div>
		<div r-component="c-footer" r-replace="true" class="footer"></div>
	</div>
<!-- 	<div id="app">
		<div r-autorefresh="{onRefresh}"></div>
	</div> -->
	<script>
		Reve.directive('autorefresh', {
			bind: function (fn) {
				var that = this
				setInterval(function () {
					that.$el.style.opacity = 0.2
					fn(function () {
						that.$el.style.opacity = 1
					})
				}, 2000)
			}
		})
		Reve.component('c-header' ,{
			data: function () {
				return {
					title: ''
				}
			},
			ready: function () {
				this.title = this.$data.title
			},
			shouldUpdate: function () {
				if (this.$data.title == this.title) return false
				this.title = this.$data.title
			}
		})
		Reve.component('c-button' ,{
			ready: function () {
			}
		})
		Reve.component('c-footer' ,{
			template: '<h6>Footer</h6>'
		})
		Reve.directive('content' ,{
			bind: function () {
				function veil (expr) {
			        return expr.replace(/\\{/g, '\uFFF0')
			                   .replace(/\\}/g, '\uFFF1')
			    }
			    function unveil (expr) {
			        return expr.replace(/\uFFF0/g, '\\{')
			                   .replace(/\uFFF1/g, '\\}')
			    }
			    function strip (expr) {
			        // -\d*\.?\d* TBD
			        var m =  expr.trim().match(/^\{([\s\S]*)\}$/m)
			        return m && m[1] ? m[1].replace(/^- /, '') : ''
			    }
				var reg = /\{[\s\S]*?\}/g
				var expr = this.expr = this.$el.innerHTML
				var veilExpr = veil(expr)
				var expressions = this.expressions = veilExpr.match(reg).map(function (exp) {
				    return strip(exp)
				})
				var parts = this.parts = veilExpr.split(reg)
				var cache = this.cache = new Array(expressions.length)
				var that = this

				var $textNode = this.textNode = new Text()

				console.log(this.$el.parentNode)
				if (this.$el.parentNode) {
					this.$el.parentNode.replaceChild($textNode, this.$el)
				}
				this.render = function (inited) {
					// set value
					expressions.forEach(function(exp, index) {
						var v = that.$exec(exp)
						if (!v[0]) cache[index] = v[1]
				    })
				    // get content
					var frags = []
			        parts.forEach(function(item, index) {
			            frags.push(item)
			            if (index < expressions.length) {
			                frags.push(cache[index])
			            }
			        })
			        // TODO, Number Mobile bug, trying to using replaceChild
			        $textNode.nodeValue = unveil(frags.join(''))
				}
				this.render(true)
			},
			shouldUpdate: function () {
				var that = this
				return this.expressions.some(function(exp, index) {
			        var pv = that.cache[index]
			        var nv = that.$exec(exp)
			        if (!nv[0]) {
			        	return that.$diff(pv, nv[1])
			        }
			    })
			},
			update: function () {
				this.render()
			}
		})
		var $app = new Reve({
			el: '#app',
			data: function () {
				return {
					show: true,
					hl: true,
					header: 'Hi, Reve'
				}
			},
			ready: function () {
				// console.log(this.$refs)
			},
			methods: {
				onDisableHightlight: function () {
					this.$data.hl = false
					this.$update()
				},
				onChangeHeader: function () {
					this.$data.header = 'Hi, fouber'
					this.$update()
				},
				onRefresh: function (cb) {
					setTimeout(function () {
						cb()
					}, 1000)
				}
			}
		})
	</script>
</body>
</html>